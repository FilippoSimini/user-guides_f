name: Summarize Commits

on:
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  get-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Crucial: 0 fetches all history for all branches and tags
      
      - name: Extract Log for Each File
        run: |
          # Find all files (excluding the .git folder) and run git log on each
          find . -type f -name "*.md" -not -path '*/.*' | while read -r file; do
              git log --stat --pretty=format:"__|__$file||%H||%s||%an||%ae||%ar||%ad||%B" -- "$file" >> commit_history.txt
              echo "_/^\_" >> commit_history.txt
          done && [ -s commit_history.txt ] && sed -i '$d' commit_history.txt

      - name: Map Emails to GitHub Usernames
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "email,username" > email_username.csv
          
          # Get unique emails, filtering out empty lines
          emails=$(git log --format='%aE' | sort -u | grep -v '^$')

          while read -r email; do
            # Find the latest commit SHA for this email
            commit_sha=$(git log --author="$email" -n 1 --format='%H')
            
            if [ -n "$commit_sha" ]; then
              # Fetch username, handling cases where the author might be null in the API
              username=$(gh api repos/${{ github.repository }}/commits/$commit_sha --jq '.author.login // "Unknown"')
              echo "$email,$username" >> email_username.csv
            fi
          done <<< "$emails"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pandas
          
      - name: Process with Python
        run: |
          # Set PYTHONPATH to the current directory so imports work correctly
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          python3 scripts/summarize_commits.py
          
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: repository-commit-log
          path: |
            commit_history.txt
            commits_summary.csv
            email_username.csv
